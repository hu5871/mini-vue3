{"version":3,"file":"reactivity.global.js","sources":["../src/effect.ts","../../shared/src/index.ts","../src/reactive.ts","../src/computed.ts","../src/ref.ts"],"sourcesContent":["let effectStack = []\nlet activeEffect;\n\nfunction clealupEffect(effect){\nconst {deps}= effect\nfor (const dep of deps) {\n  dep.delete(effect);//移除属性对应的effect\n}\n}\nexport class ReactiveEffect {\n\n  active = true;//激活状态\n  deps = [];//让effct记录它依赖了哪些属性，同时要记录当前属性依赖哪个effect\n  constructor(public fn,public scheduler?) {\n\n  }\n\n  run() {//执行fn\n    if (!this.active) { //非激活状态调用run方法\n      return this.fn()\n    }\n\n    if (!effectStack.includes(this)) {\n      try {\n        effectStack.push(activeEffect = this)\n        return this.fn();//取值 new Proxy 会执行get方法《依赖收集》\n      } finally {\n        effectStack.pop();//执行完删除栈中最后一个effect\n        activeEffect = effectStack[effectStack.length - 1]\n      }\n    }\n  }\n  stop(){//让effect和dep取消关联。，，dep上面的储存的effect移除掉\n   if(this.active){\n     clealupEffect(this)\n     this.active=false\n   }\n  }\n}\n\nexport function isTacking() {\n  return activeEffect !== undefined\n}\n\nconst targetMap = new WeakMap();\n\nexport function track(target, key) {//一个属性对应多个effect，一个effect中依赖了多个属性\n  if (!isTacking()) {//属性不依赖于effect直接跳出\n    return\n  }\n\n  let depsMap = targetMap.get(target)\n\n  if (!depsMap) {\n    targetMap.set(target, (depsMap = new Map()))//{对象：map{}}\n  }\n\n  let dep = depsMap.get(key)\n  if (!dep) {\n    depsMap.set(key, (dep = new Set()))//{对象：map{key:set:[]}}  一个属性可能对象多个effect\n  }\n\n  trackEffects(dep)\n}\n\nexport function trackEffects(dep){\n  let shouldTrack = !dep.has(activeEffect)\n  if (shouldTrack) {\n    dep.add(activeEffect)//{对象：map{key:set:[effect，effect]}} \n    activeEffect.deps.push(dep)\n  }\n}\n\nexport function trigeer(target, key) {\n  let depsMap = targetMap.get(target)\n  if (!depsMap) {\n    return\n  }\n  let deps = []\n\n  if (key !== undefined) {\n    deps.push(depsMap.get(key))\n  }\n  let effects = []\n  for (const dep of deps) {\n    effects.push(...dep)\n  }\n  triggerEffects(effects)\n}\n\nexport function effect(fn) {\n\n  const _effect = new ReactiveEffect(fn)\n  _effect.run()\n  let runner = _effect.run.bind(_effect)\n  runner._effect=_effect\n  return runner\n}\nexport function triggerEffects(dep){\n  for (const effect of dep) {//如果当前effect执行和要执行的effect是同一个，不执行，防止循环\n    if (effect !== activeEffect) {\n      if(effect.scheduler){\n        return effect.scheduler()\n      }\n      effect.run()//执行effect\n    }\n  }\n}","export function isObject(value:unknown):boolean{\n  return typeof value === 'object'&& value !== null\n}\nexport function isFunction(value:unknown):boolean{\n  return typeof value === 'function'\n}","import { isObject } from '@vue/shared';\nimport { track, trigeer } from './effect';\n\nconst enum ReactiveFlags{\n  IS_REACTIVE='__v_isReactive'\n}\n\nconst mutableHandlers:ProxyHandler<Record<any,any>>={\n  get(target,key,recevier){//recevier代理对象的本身\n \n    if(key ===ReactiveFlags.IS_REACTIVE){\n      return true\n    }\n    track(target,key)\n    //取值时，可以收集它在哪个effect中\n    const res=Reflect.get(target,key,recevier);//target[key]\n    return res\n  },\n  set(target,key,value,recevier){\n     let oldValue=(target as unknown)[key] \n   \n    const res=Reflect.set(target,key,value,recevier)//target[key]=value\n //改值时，可以触发effect更新\n   if(oldValue !== value){//值没变不需要触发effect执行\n    trigeer(target,key)\n   }\n    \n    return res\n  }\n}\n\nconst reactiveMap=new WeakMap();//弱引用 key必须是对象 如果key没有被引用可以被自动销毁\nfunction createReactiveObject(target:object){\n  \n     //先默认认为这个target已经是代理过的属性\n    if(target[ReactiveFlags.IS_REACTIVE]){\n      return target\n    }\n\n   if(!isObject(target)) {\n     //只针对对象做代理\n    return target\n   }\n\n  const exisitingProxy=reactiveMap.get(target);//如果缓存中有 直接使用上一次的代理结果 \n  if (exisitingProxy){\n   return exisitingProxy\n  }\n  const proxy=new Proxy(target,mutableHandlers)//当用户获取属性或者更改的时候 劫持到\n\n  reactiveMap.set(target,proxy)//将原对象和生成的代理对象 做一个映射表\n\n  return proxy\n}\n\nexport function reactive(target:object){\n\n  return createReactiveObject(target)\n}\nexport function readonly(){}\n\nexport function toReactive(value){\n  return isObject(value) ? reactive(value):value\n}\n// export function shallowReactive(){}\n\n\n// export function shallowReadnly(){}","import { isFunction } from \"@vue/shared\";\nimport { isTacking, ReactiveEffect, trackEffects, triggerEffects } from \"./effect\";\nclass ComputedRefImpl{\n  public dep;\n  public _dirty=true\n  public __v_isRef=true\n  public effect\n  public _value\n  constructor(getter,public setter){\n    this.effect=new ReactiveEffect(getter,()=>{\n      if(!this._dirty){\n        this._dirty=true;\n        triggerEffects(this.dep)\n      }\n    })\n  }\n\n  get value(){\n    if(isTacking()){\n      trackEffects(this.dep||(this.dep=new Set))\n    }\n    if(this._dirty){\n      //将结果缓存到this._value  不会每次都run\n      this._value=this.effect.run()\n      this._dirty=false\n    }\n   \n   return this._value\n  }\n\n  set value(newVal){\n    this.setter(newVal)\n  }\n}\nexport function computed(options){\n   const onlyGetter=isFunction(options)\n\n   let getter;\n   let setter;\n   if(onlyGetter){\n     getter=options\n     setter=()=>{}\n   }else{\n    getter=options.get\n    setter=options.set\n   }\n   return new ComputedRefImpl(getter,setter)\n}","import { isTacking, trackEffects, triggerEffects } from \"./effect\";\nimport { toReactive } from \"./reactive\";\n\nclass RefImpl{\n  public dep;\n  public __v_isRef;\n  public _value;\n  constructor(public _rawValue){\n     this._value=toReactive(_rawValue)\n  }\n\n  get value(){\n    if(isTacking()){\n      trackEffects(this.dep||(this.dep=new Set()))\n    }\n    return this._value\n  }\n\n  set value(newVal){\n   if(newVal!==this._rawValue){\n     this._rawValue=newVal\n     this._value=toReactive(newVal)\n     triggerEffects(this.dep)\n   }\n  }\n}\n\nfunction createRef(value){\n  return new RefImpl(value)\n}\n\nexport function ref(value){\n   return createRef(value)\n}"],"names":[],"mappings":"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"}